"""Tests for VulnerabilityCase, including set_embargo() bug fix."""

from datetime import datetime, timezone

import pytest

from vultron.as_vocab.objects.case_status import CaseStatus
from vultron.as_vocab.objects.embargo_event import EmbargoEvent
from vultron.as_vocab.objects.vulnerability_case import VulnerabilityCase
from vultron.bt.embargo_management.states import EM


class TestVulnerabilityCase:
    def test_init_has_one_case_status(self):
        case = VulnerabilityCase()
        assert len(case.case_status) == 1

    def test_current_status_returns_most_recent(self):
        older = CaseStatus(updated=datetime(2025, 1, 1, tzinfo=timezone.utc))
        newer = CaseStatus(updated=datetime(2025, 6, 1, tzinfo=timezone.utc))
        case = VulnerabilityCase()
        case.case_status = [older, newer]
        assert case.current_status is newer

    def test_current_status_handles_none_updated(self):
        cs = CaseStatus()
        case = VulnerabilityCase()
        case.case_status = [cs]
        # Should return the only element without error
        assert case.current_status is cs

    def test_set_embargo_sets_active_embargo(self):
        case = VulnerabilityCase()
        embargo = EmbargoEvent()
        case.set_embargo(embargo)
        assert case.active_embargo is embargo

    def test_set_embargo_updates_em_state_on_current_status(self):
        case = VulnerabilityCase()
        embargo = EmbargoEvent()
        # em_state starts as NO_EMBARGO
        assert case.current_status.em_state == EM.NO_EMBARGO
        case.set_embargo(embargo)
        assert case.current_status.em_state == EM.ACTIVE

    def test_set_embargo_updates_most_recent_case_status(self):
        older = CaseStatus(updated=datetime(2025, 1, 1, tzinfo=timezone.utc))
        newer = CaseStatus(updated=datetime(2025, 6, 1, tzinfo=timezone.utc))
        case = VulnerabilityCase()
        case.case_status = [older, newer]
        embargo = EmbargoEvent()
        case.set_embargo(embargo)
        assert newer.em_state == EM.ACTIVE
        assert older.em_state == EM.NO_EMBARGO
