#!/usr/bin/env python
"""
Provides a VulnerabilityCase object for the Vultron ActivityStreams Vocabulary.
"""
#  Copyright (c) 2023-2024 Carnegie Mellon University and Contributors.
#  - see Contributors.md for a full list of Contributors
#  - see ContributionInstructions.md for information on how you can Contribute to this project
#  Vultron Multiparty Coordinated Vulnerability Disclosure Protocol Prototype is
#  licensed under a MIT (SEI)-style license, please see LICENSE.md distributed
#  with this Software or contact permission@sei.cmu.edu for full terms.
#  Created, in part, with funding and support from the United States Government
#  (see Acknowledgments file). This program may include and/or can make use of
#  certain third party source code, object code, documentation and other files
#  (“Third Party Software”). See LICENSE.md for more details.
#  Carnegie Mellon®, CERT® and CERT Coordination Center® are registered in the
#  U.S. Patent and Trademark Office by Carnegie Mellon University

from dataclasses import dataclass, field
from typing import Optional

from dataclasses_json import LetterCase, config, dataclass_json

from vultron.as_vocab.base import activitystreams_object
from vultron.as_vocab.base.objects.activities.base import as_Activity
from vultron.as_vocab.base.utils import exclude_if_empty
from vultron.as_vocab.objects.base import VultronObject
from vultron.as_vocab.objects.case_participant import CaseParticipant
from vultron.as_vocab.objects.case_status import CaseStatus
from vultron.as_vocab.objects.embargo_event import EmbargoEvent
from vultron.as_vocab.objects.vulnerability_report import VulnerabilityReport
from vultron.bt.embargo_management.states import EM


def init_case_status():
    return [
        CaseStatus(),
    ]


@activitystreams_object
@dataclass_json(letter_case=LetterCase.CAMEL)
@dataclass
class VulnerabilityCase(VultronObject):
    """
    A Vulnerability Case is a container for vulnerability reports, and is used to track the
    lifecycle of the case and its constituent vulnerability reports, including the status of the case itself,
    the participants in the case, and the embargo status of the case.
    """

    case_participants: list[CaseParticipant] = field(
        default_factory=list, metadata=config(exclude=exclude_if_empty)
    )
    vulnerability_reports: list[VulnerabilityReport] = field(
        default_factory=list, metadata=config(exclude=exclude_if_empty)
    )
    case_status: list[CaseStatus] = field(default_factory=init_case_status)

    # don't excludeIfNone here to make it explicit when there is no embargo
    active_embargo: Optional[EmbargoEvent] = None

    proposed_embargoes: list[EmbargoEvent] = field(
        default_factory=list, metadata=config(exclude=exclude_if_empty)
    )

    case_activity: list[as_Activity] = field(
        default_factory=list, metadata=config(exclude=exclude_if_empty)
    )

    # case relationships
    parent_cases: Optional[list[str]] = field(
        default_factory=list, metadata=config(exclude=exclude_if_empty)
    )
    child_cases: Optional[list[str]] = field(
        default_factory=list, metadata=config(exclude=exclude_if_empty)
    )
    sibling_cases: Optional[list[str]] = field(
        default_factory=list, metadata=config(exclude=exclude_if_empty)
    )

    def add_report(self, report: VulnerabilityReport) -> None:
        """Add a vulnerability report to the case

        Args:
            report: a VulnerabilityReport object
        """
        self.vulnerability_reports.append(report)

    def add_participant(self, participant: CaseParticipant) -> None:
        """Add a participant to the case

        Args:
            participant: a CaseParticipant object
        """
        self.case_participants.append(participant)

    def set_embargo(self, embargo: EmbargoEvent) -> None:
        """Set the active embargo for the case

        Args:
            embargo: an EmbargoEvent object
        """
        self.active_embargo = embargo
        self.case_status.em_state = EM.ACTIVE

    def record_activity(self, activity: as_Activity) -> None:
        """Record an activity in the case

        Args:
            activity: an as_Activity object

        """
        ids = set([a.as_id for a in self.case_activity])
        if activity.as_id not in ids:
            self.case_activity.append(activity)


def main():
    obj = VulnerabilityCase()
    _json = obj.to_json(indent=2)
    print(_json)
    with open("../../../doc/examples/vulnerability_case.json", "w") as fp:
        fp.write(_json)


if __name__ == "__main__":
    main()
