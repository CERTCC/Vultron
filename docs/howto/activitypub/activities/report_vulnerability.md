# Reporting a Vulnerability

{% include-markdown "../../../includes/not_normative.md" %}

The following task flow diagram addresses the opening portion of the Report
Management process in which a finder
creates a vulnerability report and submits it to a vendor. The vendor then reads
the report and either accepts or
rejects it. If the vendor accepts the report, they create a case for it. If the
vendor rejects the report, they
eventually close it unless there's a reason to reconsider and validate it.

```mermaid
flowchart TB
    subgraph as:Create
        RmCreateReport
        CreateCase
    end
    subgraph as:Read
        RmReadReport
    end
    subgraph as:Offer
        RmSubmitReport
    end
    subgraph as:Accept
        RmValidateReport
    end
    subgraph as:Reject
        RmInvalidateReport
    end
    subgraph as:Leave
        RmCloseReport
    end
    start([Start])
    start -.-> RmCreateReport
    start --> RmSubmitReport
    RmCreateReport --> RmSubmitReport
    RmSubmitReport -.-> v{Valid?}
    RmSubmitReport --> r{Read?}
    r -->|y| RmReadReport
    r -->|n| r
    v -->|y| RmValidateReport
    RmReadReport --> v
    v -->|n| RmInvalidateReport
    RmInvalidateReport --> c{Close?}
    c -->|y| RmCloseReport
    c -->|n| v
    RmValidateReport --> CreateCase
```

{% include-markdown "./_create_report.md" heading-offset=1 %}

!!! question "`Create(Report) + Offer(Report)` vs `Offer(Report)`"

    Reports are delivered to recipients using the `Offer` activity. An `Offer`
    can include a `Report` object that the sender created immediately before
    sending. While a `Create(Report)` technically precedes an `Offer(Report)`, in
    practice the receiver usually only observes the `Offer` because the report
    was created entirely on the sender's side.

    In other cases the `Report` may have been created earlier or by a different
    actor (for example, a platform or intermediary). When that happens the
    `Create(Report)` and `Offer(Report)` are distinct activities. We show both
    patterns here to cover both workflows.

!!! example "When would `Create(Report)` be separate from `Offer(Report)`?"

    A security researcher files a report with a bug-bounty platform that
    implements Vultron. The `Create(Report)` activity happens between the
    researcher and the platform. Later, the platform submits the `Report` to a
    vendor by sending an `Offer(Report)`. The vendor receives the `Offer`
    (which contains the `Report` object) and may not be aware of the earlier
    `Create(Report)` activity.

{% include-markdown "./_submit_report.md" heading-offset=1 %}

Report submission might be followed by either a `Read` or `Accept` activity.

The `Read` activity is optional and should be used when the vendor wants to
acknowledge that they have received the report without accepting or rejecting
it.

{% include-markdown "./_read_report.md" heading-offset=1 %}

The `Accept` activity is used when the vendor wants to accept the report
and create a case for it.

{% include-markdown "./_validate_report.md" heading-offset=1 %}
{% include-markdown "./_create_case.md" heading-offset=1 %}
{% include-markdown "./_invalidate_report.md" heading-offset=1 %}
{% include-markdown "./_close_report.md" heading-offset=1 %}

## Sequence Diagrams

The following sequence diagrams illustrate the interactions between actors
during the report submission process.

### Reporter Submits Report

```mermaid
sequenceDiagram
    autonumber
    actor finder as Reporter
    box Yellow Coordination Service
        participant inbox
        participant ofr_hdlr as Offer<br/>Handler
    end
    box Yellow APIv1
        participant offers
        participant reports
    end
    finder ->> inbox: POST /inbox<br/>Offer(Report)
    activate inbox
    deactivate inbox
    activate inbox
    inbox ->> ofr_hdlr: async handler(Offer(Report))
    activate ofr_hdlr
    inbox -->> finder: 202 Accepted
    deactivate inbox
    ofr_hdlr ->> offers: POST Offer(Report)
    activate offers
    offers -->> ofr_hdlr: 200 OK
    deactivate offers
    ofr_hdlr ->> reports: POST Report
    activate reports
    reports -->> ofr_hdlr: 200 OK
    deactivate reports
    deactivate ofr_hdlr
```

### Receiver Evaluates Report

```mermaid
sequenceDiagram
    autonumber
    actor finder as Reporter
    box Yellow Coordination Service
        participant inbox
        participant accept_hdlr as Accept<br/>Handler
    end
    box Yellow APIv1
        participant offers
        participant reports
    end
    actor coordinator as Coordinator<br/>or Vendor
    note over offers: Offer(Report)<br/>already received
    activate coordinator
    coordinator ->> offers: GET /actors/{actor_id}/offers
    activate offers
    offers -->> coordinator: 200 Offer(Report)
    deactivate offers
    alt If Needed
        coordinator ->> reports: GET /reports/{report_id}
        activate reports
        reports -->> coordinator: 200 Report
        deactivate reports
    end
    note over coordinator: Evaluate Report
    alt Invalidate and Close
        coordinator ->> inbox: POST Reject(Offer(Report))
    else Invalidate and Hold
        coordinator ->> inbox: POST TentativeReject(Offer(Report))
    else Validate
        coordinator ->> inbox: POST Accept(Offer(Report))
    end
    deactivate coordinator
    note over inbox: Side effects to follow
```

### Receiver Invalidates and Closes Offered Report

```mermaid
sequenceDiagram
    autonumber
    actor finder as Reporter
    box Yellow Coordination Service
        participant inbox
        participant reject as Reject<br/>Handler
    end
    box Yellow APIv1
        participant offers
        participant reports
    end
    actor coordinator as Receiver
    note over coordinator: Evaluate<br/>Report
    activate coordinator
    coordinator ->> inbox: POST /inbox Reject(Offer(Report))
    activate inbox
    inbox ->> reject: async handler(Reject(Offer(Report)))
    activate reject
    inbox -->> coordinator: 202 Accepted
    deactivate coordinator
    deactivate inbox
    reject ->> reports: PATCH /reports/{report_id}<br/>RM.CLOSED
    activate reports
    reports ->> reports: Update Report
    reports -->> reject: 200 OK
    deactivate reports
    reject ->> offers: DELETE /offers/{offer_id}
    activate offers
    offers ->> offers: delete Offer
    offers -->> reject: 200 OK
    deactivate offers
    reject ->> finder: POST /inbox Reject(Offer(Report))
    activate finder
    finder -->> reject: 202 Accepted
    deactivate finder
    deactivate reject
```

### Receiver Invalidates and Holds Offered Report

```mermaid
sequenceDiagram
    autonumber
    actor finder as Reporter
    box Yellow Coordination Service
        participant inbox
        participant reject as Tentative Reject<br/>Handler
    end
    box Yellow APIv1
        participant offers
        participant reports
    end
    actor coordinator as Receiver
    note over coordinator: Evaluate<br/>Report
    activate coordinator
    coordinator ->> inbox: POST /inbox TentativeReject(Offer(Report))
    activate inbox
    inbox ->> reject: async handler(TentativeReject(Offer(Report)))
    activate reject
    inbox -->> coordinator: 202 Accepted
    deactivate coordinator
    deactivate inbox
    reject ->> reports: PATCH /reports/{report_id}<br/>RM.INVALID
    activate reports
    reports ->> reports: Update Report
    reports -->> reject: 200 OK
    deactivate reports
    reject ->> offers: PATCH Offer
    activate offers
    offers ->> offers: set tentative reject
    offers -->> reject: 200 OK
    deactivate offers
    reject ->> finder: POST /inbox TentativeReject(Offer(Report))
    activate finder
    finder -->> reject: 202 Accepted
    deactivate reject
    note over finder: Finder might<br/>send more<br/>info later
    deactivate finder
```

### Receiver Accepts Offered Report

```mermaid
sequenceDiagram
    autonumber
    actor finder as Reporter
    box Yellow Coordination Service
        participant inbox
        participant accept_hdlr as Accept<br/>Handler
    end
    box Yellow APIv1
        participant offers
        participant reports
        participant cases
    end
    actor coordinator as Receiver
    activate coordinator
    note over coordinator: Evaluate<br/>Report
    coordinator ->> inbox: Accept(Offer(Report))
    activate inbox
    deactivate coordinator
    inbox ->> accept_hdlr: async handler(Accept(Offer(Report)))
    deactivate inbox
    activate accept_hdlr
    accept_hdlr ->> offers: GET /actors/{actor_id}/offers/{offer_id}
    activate offers
    offers -->> accept_hdlr: Offer(Report)
    deactivate offers
    accept_hdlr ->> finder: POST /inbox Accept(Offer(Report))
    activate finder
    finder -->> accept_hdlr: 202 Accepted
    deactivate finder
    alt if needed
        accept_hdlr ->> reports: GET /reports/{report_id}
        activate reports
        reports -->> accept_hdlr: Report
        deactivate reports
    end
    accept_hdlr ->> accept_hdlr: create Case(Report)
    accept_hdlr ->> cases: POST Case(Report)
    activate cases
    cases ->> cases: store Case
    cases -->> accept_hdlr: 200 OK
    deactivate accept_hdlr
    cases ->> cases: spawn Case Service
    deactivate cases
    note over cases: Create Case<br/>side effects to follow
```

### Spawn Case Actor from Report

```mermaid
sequenceDiagram
    autonumber
    actor finder as Reporter
    box Yellow Coordination Service
        participant inbox
        participant accept_hdlr as Accept<br/>Handler
    end
    box Green Case Service
        participant c_inbox as inbox
        participant add as Add<br/>Handler
    end
    box Yellow APIv1
        participant cases
    end
    actor coordinator as Receiver
    activate accept_hdlr
    note right of accept_hdlr: Case Service<br/>Initialized
    accept_hdlr ->> coordinator: POST Create(Case)
    activate coordinator
    coordinator -->> accept_hdlr: 202 Accepted
    deactivate coordinator
    accept_hdlr ->> finder: POST Create(Case)
    activate finder
    finder -->> accept_hdlr: 202 Accepted
    deactivate finder

    par Add Receiver Participant
        note over accept_hdlr: Create Participant(Receiver)
        accept_hdlr ->> c_inbox: POST /cases/{id}/inbox<br/>Add(Participant(Receiver))
        activate c_inbox
        c_inbox ->> add: async handler<br/>(Add(Participant(Receiver)))
        activate add
        add ->> cases: POST Participant
        activate cases
        cases -->> add: 200 OK
        deactivate cases
        c_inbox -->> accept_hdlr: 202 Accepted
        deactivate c_inbox
        add ->> coordinator: POST Add(Participant(Receiver))
        activate coordinator
        coordinator -->> add: 202 Accepted
        deactivate coordinator
        deactivate add

    and Add Finder Participant
        note over accept_hdlr: Create Participant(Finder)
        accept_hdlr ->> c_inbox: POST /cases/{id}/inbox<br/>Add(Participant(Finder))
        activate c_inbox
        c_inbox ->> add: async handler<br/>(Add(Participant(Finder)))
        activate add
        add ->> cases: POST Participant
        activate cases
        cases -->> add: 200 OK
        deactivate cases
        c_inbox -->> accept_hdlr: 202 Accepted
        deactivate c_inbox
        add ->> coordinator: POST Add(Participant(Finder))
        activate coordinator
        coordinator -->> add: 202 Accepted
        deactivate coordinator
        add ->> finder: POST Add(Participant(Finder))
        activate finder
        finder -->> add: 202 Accepted
        deactivate finder
        deactivate add

    and Add Report
        accept_hdlr ->> c_inbox: Add(Report)
        activate c_inbox
        c_inbox ->> add: async handler<br/>(Add(Report))
        activate add
        c_inbox -->> accept_hdlr: 200 Accepted
        deactivate accept_hdlr
        deactivate c_inbox
        add ->> cases: POST Report
        activate cases
        cases -->> add: 200 OK
        deactivate cases
        add ->> coordinator: POST /actors/{receiver_id}/inbox<br/>Add(Report)
        activate coordinator
        coordinator -->> add: 200 Accepted
        deactivate coordinator
        add ->> finder: POST /inbox<br/>Add(Report))
        activate finder
        finder -->> add: 200 Accepted
        deactivate finder
        deactivate add
    end

```
