# Outbox Specification

## Overview

Actor outboxes hold response activities generated by handlers. The outbox
processor delivers queued activities to the appropriate recipient inboxes.

**Source**: ActivityPub specification, `specs/response-format.md` RF-06-001  
**Note**: Outbox delivery is a prototype-scope feature; full federation delivery
is deferred to future work.

---

## Outbox Structure (MUST)

- `OX-01-001` Each actor MUST have an outbox collection
- `OX-01-002` Outbox MUST preserve insertion order (FIFO)
- `OX-01-003` Activities added to outbox MUST be persisted to DataLayer
  immediately

## Outbox Population (MUST)

- `OX-02-001` Handlers that generate response activities MUST add them to the
  actor's outbox
  - Use `actor.outbox.append(activity)` then persist via
    `dl.update(actor.as_id, object_to_record(actor))`
- `OX-02-002` Each outbox activity MUST conform to ActivityStreams 2.0 structure
  - See `specs/response-format.md` for response activity requirements

## Outbox Delivery (MUST)

- `OX-03-001` Activities in an actor's outbox MUST be delivered to recipient
  inboxes
- `OX-03-002` Delivery MUST occur after the generating handler completes
- `OX-03-003` Delivery MUST NOT block inbox HTTP response
  - **Implementation**: Use FastAPI BackgroundTasks or a follow-on background
    task after the handler

## Local Delivery (MUST)

- `OX-04-001` For actors on the same server, delivery MUST write directly to the
  recipient actor's inbox collection in the DataLayer
- `OX-04-002` Local delivery MUST persist the inbox update immediately

## Federation Delivery (MAY)

- `OX-05-001` `PROD_ONLY` For remote actors, the system MAY deliver via HTTP POST to the
  remote actor's inbox URL
  - **Deferred**: Full federation delivery is out of scope for the current
    prototype
- `OX-05-002` `PROD_ONLY` Remote delivery failures SHOULD be logged at WARNING level and
  retried

## Delivery Idempotency (MUST)

- `OX-06-001` Outbox delivery MUST be idempotent
  - Delivering the same activity twice MUST NOT create duplicate inbox entries
  - **Cross-reference**: `specs/idempotency.md` for complete idempotency
    requirements

## Verification

### OX-01-001, OX-01-002, OX-01-003 Verification

- Unit test: Actor model has `outbox` collection field
- Unit test: Outbox preserves insertion order after round-trip through DataLayer
- Integration test: Handler outbox write persists after actor update

### OX-02-001, OX-02-002 Verification

- Unit test: Handler generates response activity and appends to outbox
- Unit test: Response activity conforms to ActivityStreams 2.0 schema
- Integration test: Actor outbox contains expected activity after handler runs

### OX-03-001, OX-03-002, OX-03-003 Verification

- Integration test: Outbox activity delivered to recipient inbox
- Integration test: Delivery occurs after handler completion
- Integration test: HTTP 202 returned before delivery completes

### OX-04-001, OX-04-002 Verification

- Integration test: Local actor receives activity in inbox after delivery
- Integration test: Inbox update persisted to DataLayer

### OX-06-001 Verification

- Integration test: Delivering same activity twice â†’ recipient inbox has one copy

## Related

- **Response Format**: `specs/response-format.md` (response activity structure)
- **Idempotency**: `specs/idempotency.md` (duplicate delivery prevention)
- **Inbox Endpoint**: `specs/inbox-endpoint.md` (receiving delivered activities)
- **Handler Protocol**: `specs/handler-protocol.md` (handler generates responses)
- **Implementation**: `vultron/api/v2/backend/handlers.py` (outbox population)
- **Implementation**: (Future) `vultron/api/v2/backend/outbox.py` (delivery)
- **Tests**: (Future) `test/api/v2/backend/test_outbox.py`
